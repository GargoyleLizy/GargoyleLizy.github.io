<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Linkify Dashboard</title>
    <style>
        body { font-family: 'Inter', sans-serif; background: #0d1117; color: #c9d1d9; display: grid; grid-template-columns: 360px 1fr; height: 100vh; margin: 0; }
        .sidebar { background: #161b22; padding: 25px; border-right: 1px solid #30363d; overflow-y: auto; }
        .main { padding: 40px; overflow-y: auto; background: #0d1117; }
        input, textarea { width: 100%; margin: 10px 0; padding: 12px; border-radius: 6px; border: 1px solid #30363d; background: #0d1117; color: white; box-sizing: border-box; }
        button { width: 100%; background: #238636; color: white; padding: 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .widget-card { background: #1c2128; border: 1px solid #30363d; padding: 18px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .copy-link { font-family: monospace; font-size: 11px; color: #8b949e; background: #0d1117; padding: 4px 8px; border-radius: 4px; display: block; margin-top: 5px; cursor: pointer; }
        .nav-link { color: #8b949e; text-decoration: none; font-size: 13px; display: inline-block; margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="sidebar">
    <a href="../index.html" class="nav-link">‚Üê Return to Home</a>
    <h3>üõ†Ô∏è Widget Creator</h3>
    <div style="display: flex; gap: 8px; align-items: center; margin: 10px 0;">
        <input type="password" id="pat" placeholder="GitHub Token (PAT)" style="margin: 0; flex: 1;">
        <button onclick="window.open('https://github.com/settings/personal-access-tokens', '_blank')" style="width: auto; background: #21262d; border: 1px solid #30363d; padding: 0 10px; height: 42px; margin: 0; font-size: 12px; color: #58a6ff; white-space: nowrap;">üîë Get Token</button>
    </div>
    <input type="text" id="user" placeholder="GitHub Username">
    <input type="text" id="repo" placeholder="Repo Name">
    <button onclick="fetchList()" style="background: #21262d; border: 1px solid #30363d; color: #c9d1d9; margin-top: 5px; margin-bottom: 15px;">üîÑ Load Library</button>
    <hr style="border:0; border-top:1px solid #30363d; margin:20px 0;">
    <input type="text" id="filename" placeholder="gold-chart.html">
    <textarea id="code" rows="6" placeholder="Paste TradingView Code Here..."></textarea>
    <button onclick="deploy()">Deploy to /linkify_dashboard/</button>
    <p id="status" style="font-size: 12px; color: #7ee787; margin-top: 15px;"></p>
</div>

<div class="main">
    <h2>üìö Widget Library</h2>
    <p>Stored in <code>/linkify_dashboard/</code></p>
    <div id="file-list">Loading widgets...</div>
</div>

<div style="position: fixed; bottom: 10px; right: 15px; font-size: 12px; color: #8b949e; opacity: 0.7; font-family: monospace;">v1.0.1</div>

<script>
    window.onload = () => {
        document.getElementById('pat').value = localStorage.getItem('gh_token') || '';
        
        let valUser = localStorage.getItem('gh_user') || '';
        let valRepo = localStorage.getItem('gh_repo') || '';

        const host = window.location.hostname;
        const path = window.location.pathname;

        if (host.endsWith('.github.io')) {
            if (!valUser) valUser = host.split('.')[0];
            if (!valRepo) valRepo = host;
        } else {
            const repoPart = path.split('/').find(p => p.endsWith('.github.io'));
            if (repoPart) {
                if (!valUser) valUser = repoPart.split('.')[0];
                if (!valRepo) valRepo = repoPart;
            }
        }

        document.getElementById('user').value = valUser;
        document.getElementById('repo').value = valRepo;
        if(valUser) fetchList();
    };

    async function deploy() {
        const token = document.getElementById('pat').value.trim();
        const user = document.getElementById('user').value.trim();
        const repo = document.getElementById('repo').value.trim();
        const filename = document.getElementById('filename').value.trim();
        const widgetBody = document.getElementById('code').value;

        if (!token || !user || !repo || !filename) {
            alert("Please fill in all fields (Token, Username, Repo, Filename).");
            return;
        }

        localStorage.setItem('gh_token', token);
        localStorage.setItem('gh_user', user);
        localStorage.setItem('gh_repo', repo);

        const fullHTML = `<!DOCTYPE html><html><head><style>body{margin:0;background:#000;color:#58a6ff;font-family:sans-serif;}.nav{padding:8px;background:#161b22;border-bottom:1px solid #30363d;font-size:12px;}.container{height:610px;width:980px;margin:20px auto;position:relative;overflow:hidden;border:1px solid #30363d;border-radius:8px;}.container > div, .container > iframe {height:100%;width:100%;border:none;}</style></head><body><div class="nav"><a href="index.html" style="color:inherit;text-decoration:none;">‚Üê Back to Dashboard</a></div><div class="container">${widgetBody}</div></body></html>`;

        // Path is now specifically linkify_dashboard/
        const apiUrl = `https://api.github.com/repos/${user}/${repo}/contents/linkify_dashboard/${filename}`;
        
        let sha = "";
        try {
            const check = await fetch(apiUrl, { headers: {'Authorization': `token ${token}`} });
            if(check.ok) { const d = await check.json(); sha = d.sha; }
        } catch(e) {}

        const res = await fetch(apiUrl, {
            method: 'PUT',
            headers: {'Authorization': `token ${token}`, 'Content-Type': 'application/json'},
            body: JSON.stringify({
                message: `New Widget: ${filename}`,
                content: btoa(unescape(encodeURIComponent(fullHTML))),
                sha: sha || undefined
            })
        });

        if(res.ok) {
            document.getElementById('status').innerText = "‚úÖ Deployed! Refreshing list...";
            setTimeout(fetchList, 2000);
        } else {
            alert("Error. Ensure PAT has 'repo' permissions.");
        }
    }

    async function fetchList() {
        const user = document.getElementById('user').value.trim();
        const repo = document.getElementById('repo').value.trim();
        const listDiv = document.getElementById('file-list');

        try {
            // Fetch contents of the linkify_dashboard folder
            const res = await fetch(`https://api.github.com/repos/${user}/${repo}/contents/linkify_dashboard`);
            const files = await res.json();
            
            const htmlFiles = files.filter(f => f.name.endsWith('.html') && f.name !== 'index.html');
            
            if (htmlFiles.length === 0) {
                listDiv.innerHTML = "<p style='color: #8b949e;'>No widgets found. Library loaded.</p>";
                return;
            }

            listDiv.innerHTML = htmlFiles.map(f => {
                const sourceUrl = f.html_url;
                // GitHub Pages URL logic: User sites are at root, Project sites are at /repo-name/
                const isUserSite = repo.toLowerCase() === `${user.toLowerCase()}.github.io`;
                const embedUrl = `https://${user.toLowerCase()}.github.io${isUserSite ? '' : '/' + repo}/linkify_dashboard/${f.name}`;
                return `
                <div class="widget-card">
                    <div>
                        <strong>${f.name.replace('.html', '')}</strong>
                        <span class="copy-link" onclick="navigator.clipboard.writeText('${sourceUrl}'); alert('Link Copied!');">${sourceUrl}</span>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <a href="${sourceUrl}" target="_blank" style="background:#21262d; color:#58a6ff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:13px;">View Source</a>
                        <a href="${embedUrl}" target="_blank" style="background:#21262d; color:#58a6ff; padding:8px 15px; border-radius:6px; text-decoration:none; font-size:13px;">Embed View</a>
                    </div>
                </div>`;
            }).join('');
        } catch(e) {
            listDiv.innerHTML = "<p>Ready to scan. Please fill in credentials.</p>";
        }
    }
</script>
</body>
</html>